<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMS Creative Lab ‚Äî DonorBureau Toolkit</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --accent: #6366f1;
    --accent2: #818cf8;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
    --orange: #f97316;
    --text: #e2e8f0;
    --text2: #94a3b8;
    --border: #2d3348;
    --radius: 12px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-height: 100vh; }

  .header { background: linear-gradient(135deg, #1e1b4b, #312e81); padding: 24px 32px; border-bottom: 1px solid var(--border); }
  .header h1 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .header h1 span { color: var(--accent2); }
  .header p { color: var(--text2); margin-top: 4px; font-size: 14px; }

  .tabs { display: flex; gap: 0; background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 32px; overflow-x: auto; }
  .tab { padding: 14px 20px; cursor: pointer; color: var(--text2); font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent2); border-bottom-color: var(--accent); }

  .container { max-width: 1200px; margin: 0 auto; padding: 24px 32px; }

  .panel { display: none; }
  .panel.active { display: block; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
  .card h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

  label { font-size: 13px; color: var(--text2); display: block; margin-bottom: 6px; font-weight: 500; }
  input, select, textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px 14px; font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.2s; }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  textarea { resize: vertical; min-height: 100px; line-height: 1.5; }

  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .field { margin-bottom: 14px; }

  .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-sm { padding: 6px 14px; font-size: 13px; }
  .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

  .counter { font-size: 13px; font-weight: 600; padding: 4px 10px; border-radius: 6px; display: inline-flex; align-items: center; gap: 4px; }
  .counter.ok { background: rgba(34,197,94,0.15); color: var(--green); }
  .counter.warn { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .counter.over { background: rgba(239,68,68,0.15); color: var(--red); }

  .badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 600; text-transform: uppercase; }
  .badge-sms { background: rgba(99,102,241,0.2); color: var(--accent2); }
  .badge-mms { background: rgba(249,115,22,0.2); color: var(--orange); }
  .badge-ok { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-warn { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .badge-error { background: rgba(239,68,68,0.15); color: var(--red); }

  .preview-phone { background: #000; border-radius: 32px; padding: 12px; max-width: 320px; margin: 0 auto; }
  .preview-screen { background: #1c1c1e; border-radius: 24px; padding: 16px 12px; min-height: 200px; }
  .preview-bubble { background: #34c759; color: white; padding: 10px 14px; border-radius: 18px 18px 4px 18px; font-size: 14px; line-height: 1.4; margin-bottom: 8px; word-wrap: break-word; max-width: 90%; margin-left: auto; }
  .preview-time { text-align: center; color: #666; font-size: 11px; margin-bottom: 8px; }

  .merge-tag { background: rgba(99,102,241,0.3); color: var(--accent2); padding: 1px 6px; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; }

  .compliance-list { list-style: none; }
  .compliance-list li { padding: 8px 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-size: 14px; }
  .compliance-list li:last-child { border: none; }

  .variant-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 10px; }
  .variant-card .variant-label { font-size: 12px; color: var(--accent2); font-weight: 600; margin-bottom: 6px; }
  .variant-card .variant-text { font-size: 14px; line-height: 1.5; }

  .ask-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
  .ask-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; }
  .ask-item .amount { font-size: 18px; font-weight: 700; color: var(--green); }
  .ask-item .label { font-size: 11px; color: var(--text2); margin-top: 2px; }

  .stat-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
  .stat { background: var(--surface2); border-radius: 8px; padding: 14px 18px; flex: 1; min-width: 120px; }
  .stat .val { font-size: 24px; font-weight: 700; color: var(--accent2); }
  .stat .lbl { font-size: 12px; color: var(--text2); margin-top: 2px; }

  .template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .template-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s; }
  .template-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .template-card h4 { font-size: 14px; margin-bottom: 6px; }
  .template-card p { font-size: 12px; color: var(--text2); line-height: 1.4; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.3s ease; }

  .hidden { display: none; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<div class="header">
  <h1>üì± <span>SMS Creative Lab</span></h1>
  <p>DonorBureau Creative Toolkit ‚Äî Write, validate, preview, and generate fundraising copy</p>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('compose')">‚úçÔ∏è Compose</div>
  <div class="tab" onclick="switchTab('variants')">üîÑ A/B Variants</div>
  <div class="tab" onclick="switchTab('askstrings')">üí∞ Ask Strings</div>
  <div class="tab" onclick="switchTab('templates')">üìã Templates</div>
  <div class="tab" onclick="switchTab('compliance')">üõ°Ô∏è Compliance</div>
  <div class="tab" onclick="switchTab('calculator')">üìä Yield Calculator</div>
</div>

<div class="container">

  <!-- COMPOSE TAB -->
  <div class="panel active" id="panel-compose">
    <div class="row">
      <div>
        <div class="card">
          <h3>üìù Message Composer</h3>
          <div class="row">
            <div class="field">
              <label>Type</label>
              <select id="msgType" onchange="updateCompose()">
                <option value="sms">SMS (Text Only)</option>
                <option value="mms">MMS (With Image)</option>
              </select>
            </div>
            <div class="field">
              <label>Client / Campaign</label>
              <input type="text" id="campaign" placeholder="e.g. NRSC-Feb-Midterm">
            </div>
          </div>
          <div class="field">
            <label>Message Body</label>
            <textarea id="msgBody" rows="6" placeholder="{{FIRSTNAME}}, your country needs you. Will you chip in $25 to help us win in November? {{LINK}}" oninput="updateCompose()"></textarea>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
            <div>
              <span class="counter" id="charCounter">0 / 160</span>
              <span class="badge badge-sms" id="segmentBadge" style="margin-left:8px;">1 segment</span>
            </div>
            <div class="btn-group" style="margin:0;">
              <button class="btn btn-sm btn-secondary" onclick="insertMerge('{{FIRSTNAME}}')">+ FIRSTNAME</button>
              <button class="btn btn-sm btn-secondary" onclick="insertMerge('{{LINK}}')">+ LINK</button>
              <button class="btn btn-sm btn-secondary" onclick="insertMerge('{{AMOUNT}}')">+ AMOUNT</button>
              <button class="btn btn-sm btn-secondary" onclick="insertMerge('{{LASTNAME}}')">+ LASTNAME</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üîç Quick Checks</h3>
          <ul class="compliance-list" id="quickChecks">
            <li><span>Type a message above to see checks...</span></li>
          </ul>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>üì± Preview</h3>
          <div class="preview-phone">
            <div class="preview-screen">
              <div class="preview-time">Today 3:29 PM</div>
              <div class="preview-bubble" id="previewBubble">
                Your message preview will appear here...
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üìä Merge Fields Detected</h3>
          <div id="mergeFieldsList" style="font-size:14px; color:var(--text2);">None yet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- A/B VARIANTS TAB -->
  <div class="panel" id="panel-variants">
    <div class="card">
      <h3>üîÑ A/B Variant Generator</h3>
      <p style="font-size:14px; color:var(--text2); margin-bottom:16px;">Paste your control copy, select strategies, and generate test variants.</p>
      <div class="field">
        <label>Control Copy (your baseline)</label>
        <textarea id="controlCopy" rows="4" placeholder="{{FIRSTNAME}}, the radical Left is trying to destroy everything we've built. Will you rush $25 to stop them? {{LINK}}"></textarea>
      </div>
      <div class="field">
        <label>Variant Strategies (select multiple)</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="strat-check" value="urgency" checked> üî• Urgency</label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="strat-check" value="gratitude"> üôè Gratitude</label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="strat-check" value="anger"> üò† Anger/Outrage</label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="strat-check" value="exclusive"> ‚≠ê Exclusivity</label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="strat-check" value="social_proof"> üë• Social Proof</label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="strat-check" value="personal"> üí¨ Personal/Direct</label>
        </div>
      </div>
      <button class="btn btn-primary" onclick="generateVariants()">‚ö° Generate Variants</button>
      <div id="variantResults" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- ASK STRINGS TAB -->
  <div class="panel" id="panel-askstrings">
    <div class="card">
      <h3>üí∞ Ask String Builder</h3>
      <p style="font-size:14px; color:var(--text2); margin-bottom:16px;">Configure ask amounts based on donor segment and history.</p>
      <div class="row3">
        <div class="field">
          <label>Segment</label>
          <select id="askSegment" onchange="updateAskStrings()">
            <option value="prospect">Prospect (New)</option>
            <option value="low">Low Dollar ($1-$24)</option>
            <option value="mid">Mid Dollar ($25-$99)</option>
            <option value="high">High Dollar ($100-$499)</option>
            <option value="major">Major Donor ($500+)</option>
          </select>
        </div>
        <div class="field">
          <label>Strategy</label>
          <select id="askStrategy" onchange="updateAskStrings()">
            <option value="standard">Standard Ladder</option>
            <option value="upgrade">Upgrade Ask (+1 tier)</option>
            <option value="aggressive">Aggressive (+2 tiers)</option>
            <option value="retention">Retention (at/below LG)</option>
            <option value="reactivation">Reactivation (low barrier)</option>
          </select>
        </div>
        <div class="field">
          <label>Last Gift Amount</label>
          <input type="number" id="lastGift" value="25" onchange="updateAskStrings()">
        </div>
      </div>
      <div class="card" style="margin-top:16px; background:var(--surface2);">
        <h3>Generated Ask String</h3>
        <div id="askDisplay" class="ask-grid"></div>
        <div style="margin-top:12px;">
          <label>Copy-Paste Format</label>
          <input type="text" id="askCopyText" readonly style="font-family:monospace; font-size:13px;">
        </div>
      </div>
    </div>
  </div>

  <!-- TEMPLATES TAB -->
  <div class="panel" id="panel-templates">
    <div class="card">
      <h3>üìã Quick-Start Templates</h3>
      <p style="font-size:14px; color:var(--text2); margin-bottom:16px;">Click a template to load it into the composer.</p>
      <div class="template-grid" id="templateGrid"></div>
    </div>
  </div>

  <!-- COMPLIANCE TAB -->
  <div class="panel" id="panel-compliance">
    <div class="card">
      <h3>üõ°Ô∏è Compliance Checker</h3>
      <p style="font-size:14px; color:var(--text2); margin-bottom:16px;">Paste full message copy to check against common compliance rules.</p>
      <div class="field">
        <label>Message to Check</label>
        <textarea id="complianceText" rows="6" placeholder="Paste your message here..." oninput="runComplianceCheck()"></textarea>
      </div>
      <div id="complianceResults" style="margin-top:16px;"></div>
    </div>

    <div class="card">
      <h3>üìè Key Rules Reference</h3>
      <ul class="compliance-list">
        <li>üìè SMS: 160 chars/segment (70 if Unicode). MMS: 1600 chars max body.</li>
        <li>üîó Always include opt-out language or STOP info for first-touch messages</li>
        <li>üè∑Ô∏è Must identify sender organization</li>
        <li>‚öñÔ∏è No false claims of matching/multiplying without verified match sponsor</li>
        <li>üö´ Avoid "guaranteed" / "promise" language for outcomes</li>
        <li>üìã FCC/TCPA: Prior express written consent required for autodialed texts</li>
        <li>üí∞ "Paid for by" required for political committees</li>
        <li>üîí Don't impersonate candidates in first person unless authorized</li>
      </ul>
    </div>
  </div>

  <!-- YIELD CALCULATOR TAB -->
  <div class="panel" id="panel-calculator">
    <div class="card">
      <h3>üìä Campaign Yield Calculator</h3>
      <p style="font-size:14px; color:var(--text2); margin-bottom:16px;">Estimate revenue and ROI for a send.</p>
      <div class="row3">
        <div class="field">
          <label>List Size</label>
          <input type="number" id="listSize" value="100000" oninput="calcYield()">
        </div>
        <div class="field">
          <label>CTR (%)</label>
          <input type="number" id="ctr" value="2.5" step="0.1" oninput="calcYield()">
        </div>
        <div class="field">
          <label>Conversion Rate (%)</label>
          <input type="number" id="convRate" value="8" step="0.5" oninput="calcYield()">
        </div>
      </div>
      <div class="row3">
        <div class="field">
          <label>Avg Gift ($)</label>
          <input type="number" id="avgGift" value="32" step="1" oninput="calcYield()">
        </div>
        <div class="field">
          <label>Cost per Message ($)</label>
          <input type="number" id="costPerMsg" value="0.015" step="0.001" oninput="calcYield()">
        </div>
        <div class="field">
          <label>Segments to Send</label>
          <input type="number" id="segments" value="1" step="1" oninput="calcYield()">
        </div>
      </div>

      <div class="stat-row" id="yieldStats"></div>

      <div class="card" style="background:var(--surface2);">
        <h3>üìà Scenario Comparison</h3>
        <div id="scenarioTable" style="font-size:14px; overflow-x:auto;"></div>
      </div>
    </div>
  </div>

</div>

<script>
// === TAB SWITCHING ===
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('panel-' + name).classList.add('active');
}

// === COMPOSE ===
function insertMerge(tag) {
  const ta = document.getElementById('msgBody');
  const start = ta.selectionStart;
  const end = ta.selectionEnd;
  ta.value = ta.value.substring(0, start) + tag + ta.value.substring(end);
  ta.focus();
  ta.selectionStart = ta.selectionEnd = start + tag.length;
  updateCompose();
}

function updateCompose() {
  const body = document.getElementById('msgBody').value;
  const type = document.getElementById('msgType').value;
  const maxSingle = type === 'sms' ? 160 : 1600;
  const maxConcat = type === 'sms' ? 153 : 1600; // concat segment size

  // Character counting
  const len = body.length;
  const segments = len <= maxSingle ? 1 : Math.ceil(len / maxConcat);
  const counter = document.getElementById('charCounter');
  counter.textContent = `${len} / ${maxSingle}`;
  counter.className = 'counter ' + (len <= maxSingle ? 'ok' : len <= maxSingle * 2 ? 'warn' : 'over');

  const segBadge = document.getElementById('segmentBadge');
  segBadge.textContent = `${segments} segment${segments > 1 ? 's' : ''}`;
  segBadge.className = 'badge ' + (type === 'sms' ? 'badge-sms' : 'badge-mms');

  // Preview
  const preview = document.getElementById('previewBubble');
  let previewText = body || 'Your message preview will appear here...';
  previewText = previewText
    .replace(/\{\{FIRSTNAME\}\}/g, 'John')
    .replace(/\{\{LASTNAME\}\}/g, 'Smith')
    .replace(/\{\{LINK\}\}/g, 'https://don8.co/abc123')
    .replace(/\{\{AMOUNT\}\}/g, '$25');
  preview.textContent = previewText;

  // Merge fields
  const merges = body.match(/\{\{[A-Z_]+\}\}/g) || [];
  const mergeDiv = document.getElementById('mergeFieldsList');
  if (merges.length > 0) {
    mergeDiv.innerHTML = [...new Set(merges)].map(m => `<span class="merge-tag">${m}</span>`).join(' ');
  } else {
    mergeDiv.textContent = 'None detected';
  }

  // Quick checks
  const checks = [];
  if (len === 0) {
    checks.push({ icon: '‚è≥', text: 'Start typing to see checks', status: 'neutral' });
  } else {
    // Length check
    if (type === 'sms' && len <= 160) checks.push({ icon: '‚úÖ', text: `SMS length OK (${len}/160)` });
    else if (type === 'sms' && len <= 320) checks.push({ icon: '‚ö†Ô∏è', text: `${segments} segments ‚Äî consider shortening` });
    else if (type === 'sms') checks.push({ icon: '‚ùå', text: `${segments} segments ‚Äî too long for SMS` });
    else if (len <= 1600) checks.push({ icon: '‚úÖ', text: `MMS length OK (${len}/1600)` });
    else checks.push({ icon: '‚ùå', text: `MMS over limit (${len}/1600)` });

    // Merge field check
    const invalidMerges = body.match(/\{[A-Z_]+\}(?!\})/g) || body.match(/\{\{[a-z_]+\}\}/g);
    if (invalidMerges) checks.push({ icon: '‚ö†Ô∏è', text: 'Possible malformed merge fields detected' });
    if (merges.length > 0) checks.push({ icon: '‚úÖ', text: `${merges.length} merge field(s) found` });

    // Link check
    if (body.includes('{{LINK}}') || body.match(/https?:\/\//)) checks.push({ icon: '‚úÖ', text: 'Contains link/CTA' });
    else checks.push({ icon: '‚ö†Ô∏è', text: 'No link detected ‚Äî add {{LINK}} or URL' });

    // STOP language
    if (/stop|opt.?out|unsubscribe|reply stop/i.test(body)) checks.push({ icon: '‚úÖ', text: 'Opt-out language present' });
    else checks.push({ icon: 'üí°', text: 'Consider adding opt-out language (STOP)' });

    // Org identification
    if (/paid for by|from |sent by/i.test(body)) checks.push({ icon: '‚úÖ', text: 'Sender identified' });
    else checks.push({ icon: 'üí°', text: 'Consider identifying the sending org' });
  }

  document.getElementById('quickChecks').innerHTML = checks.map(c =>
    `<li>${c.icon} ${c.text}</li>`
  ).join('');
}

// === VARIANTS ===
const variantTemplates = {
  urgency: [
    "üö® {{FIRSTNAME}}, this is URGENT. We're $X short of our deadline goal. Rush {{AMOUNT}} before midnight: {{LINK}}",
    "‚è∞ TIME'S UP ‚Äî {{FIRSTNAME}}, we MUST hit our goal in the next 3 hours. Every dollar counts: {{LINK}}",
    "BREAKING: {{FIRSTNAME}}, if we don't raise $X by midnight, we LOSE this fight. {{LINK}}"
  ],
  gratitude: [
    "{{FIRSTNAME}}, THANK YOU. Supporters like you are the reason we're still fighting. Can we count on you again? {{LINK}}",
    "{{FIRSTNAME}}, we haven't forgotten what you did. Your support changed everything. Will you stand with us once more? {{LINK}}",
    "Because of patriots like you, {{FIRSTNAME}}, we're winning. Help us finish the job: {{LINK}}"
  ],
  anger: [
    "{{FIRSTNAME}}, they think we'll just give up. They're WRONG. Fight back NOW: {{LINK}}",
    "UNBELIEVABLE. They're trying to silence us, {{FIRSTNAME}}. We need {{AMOUNT}} to fight back: {{LINK}}",
    "{{FIRSTNAME}}, are you as angry as we are? The time to act is NOW: {{LINK}}"
  ],
  exclusive: [
    "{{FIRSTNAME}}, you've been selected for our inner circle. Exclusive 5X match activated: {{LINK}}",
    "Only our top supporters are seeing this, {{FIRSTNAME}}. Special {{AMOUNT}} challenge: {{LINK}}",
    "{{FIRSTNAME}}, this message is for our VIP list only. Your {{AMOUNT}} gift will be TRIPLED: {{LINK}}"
  ],
  social_proof: [
    "{{FIRSTNAME}}, 47,832 patriots have already stepped up. Don't be left out: {{LINK}}",
    "WOW ‚Äî {{FIRSTNAME}}, donations are FLOODING in. Join the movement: {{LINK}}",
    "{{FIRSTNAME}}, your neighbors are stepping up. 12,000+ donations in the last hour. Add yours: {{LINK}}"
  ],
  personal: [
    "Hey {{FIRSTNAME}} ‚Äî I'm reaching out personally because this matters. Can I count on you? {{LINK}}",
    "{{FIRSTNAME}}, I need to ask you directly: will you chip in {{AMOUNT}} right now? {{LINK}}",
    "{{FIRSTNAME}}, I wouldn't text you if it wasn't important. We really need your help today: {{LINK}}"
  ]
};

function generateVariants() {
  const control = document.getElementById('controlCopy').value;
  const strategies = [...document.querySelectorAll('.strat-check:checked')].map(c => c.value);

  if (!control && strategies.length === 0) {
    document.getElementById('variantResults').innerHTML = '<p style="color:var(--text2)">Enter control copy and select strategies.</p>';
    return;
  }

  let html = '';
  strategies.forEach(strat => {
    const templates = variantTemplates[strat] || [];
    const stratName = { urgency: 'üî• Urgency', gratitude: 'üôè Gratitude', anger: 'üò† Anger', exclusive: '‚≠ê Exclusivity', social_proof: 'üë• Social Proof', personal: 'üí¨ Personal' }[strat];

    templates.forEach((t, i) => {
      const len = t.replace(/\{\{[A-Z_]+\}\}/g, 'XXXXXXXX').length;
      html += `<div class="variant-card fade-in">
        <div class="variant-label">${stratName} ‚Äî Variant ${String.fromCharCode(65 + i)}</div>
        <div class="variant-text">${t.replace(/\{\{(\w+)\}\}/g, '<span class="merge-tag">{{$1}}</span>')}</div>
        <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
          <span class="counter ${len <= 160 ? 'ok' : 'warn'}">${len} chars (est.)</span>
          <button class="btn btn-sm btn-secondary" onclick="loadToComposer('${t.replace(/'/g, "\\'")}')">Load to Composer ‚Üí</button>
        </div>
      </div>`;
    });
  });

  if (control) {
    const controlLen = control.replace(/\{\{[A-Z_]+\}\}/g, 'XXXXXXXX').length;
    html = `<div class="variant-card" style="border-color:var(--accent);">
      <div class="variant-label" style="color:var(--green);">üéØ Control (Baseline)</div>
      <div class="variant-text">${control.replace(/\{\{(\w+)\}\}/g, '<span class="merge-tag">{{$1}}</span>')}</div>
      <span class="counter ${controlLen <= 160 ? 'ok' : 'warn'}" style="margin-top:8px;">${controlLen} chars (est.)</span>
    </div>` + html;
  }

  document.getElementById('variantResults').innerHTML = html;
}

function loadToComposer(text) {
  document.getElementById('msgBody').value = text;
  switchTab('compose');
  document.querySelector('.tab').click();
  updateCompose();
}

// === ASK STRINGS ===
const askLadders = {
  prospect:     { standard: [5,10,25,50], upgrade: [10,25,50,100], aggressive: [25,50,100,250], retention: [5,10,15,25], reactivation: [3,5,10,15] },
  low:          { standard: [10,15,25,50], upgrade: [15,25,50,100], aggressive: [25,50,100,250], retention: [5,10,15,25], reactivation: [5,10,15,25] },
  mid:          { standard: [25,50,75,100], upgrade: [50,75,100,250], aggressive: [75,100,250,500], retention: [15,25,35,50], reactivation: [10,15,25,50] },
  high:         { standard: [50,100,250,500], upgrade: [100,250,500,1000], aggressive: [250,500,1000,2500], retention: [50,75,100,150], reactivation: [25,50,75,100] },
  major:        { standard: [250,500,1000,2500], upgrade: [500,1000,2500,5000], aggressive: [1000,2500,5000,10000], retention: [100,250,500,750], reactivation: [50,100,250,500] }
};

function updateAskStrings() {
  const seg = document.getElementById('askSegment').value;
  const strat = document.getElementById('askStrategy').value;
  const lastGift = parseInt(document.getElementById('lastGift').value) || 25;

  let amounts = askLadders[seg][strat];

  // Adjust based on last gift for retention
  if (strat === 'retention') {
    amounts = [
      Math.round(lastGift * 0.5),
      Math.round(lastGift * 0.75),
      lastGift,
      Math.round(lastGift * 1.25)
    ];
  }

  const display = document.getElementById('askDisplay');
  display.innerHTML = amounts.map((a, i) => {
    const labels = ['Anchor Low', 'Sweet Spot', 'Stretch', 'Reach'];
    return `<div class="ask-item">
      <div class="amount">$${a.toLocaleString()}</div>
      <div class="label">${labels[i] || 'Option'}</div>
    </div>`;
  }).join('');

  document.getElementById('askCopyText').value = amounts.map(a => `$${a}`).join(' / ');
}

// === TEMPLATES ===
const templates = [
  { name: 'üî• Breaking News Alert', category: 'Urgency', body: 'BREAKING: {{FIRSTNAME}}, we just got word ‚Äî [EVENT]. We need {{AMOUNT}} from every patriot to fight back. Rush your gift NOW: {{LINK}}' },
  { name: 'üó≥Ô∏è Election Deadline', category: 'Urgency', body: '{{FIRSTNAME}}, Election Day is [X] days away. We\'re $[X] short. Your {{AMOUNT}} could make the difference between WINNING and losing: {{LINK}}' },
  { name: 'üôè Thank You + Re-ask', category: 'Gratitude', body: '{{FIRSTNAME}}, THANK YOU for your $[LAST_GIFT] gift. Because of you, [IMPACT]. Can we count on you again? {{LINK}}' },
  { name: '‚≠ê VIP Match Offer', category: 'Match', body: '{{FIRSTNAME}}, you\'ve been SELECTED! Your next gift will be MATCHED up to 5X. That means your {{AMOUNT}} becomes $[5X]. Claim your match: {{LINK}}' },
  { name: 'üìä Progress Update', category: 'Update', body: '{{FIRSTNAME}} ‚Äî GREAT NEWS! We hit [X]% of our goal thanks to supporters like you. Help us cross the finish line with {{AMOUNT}}: {{LINK}}' },
  { name: 'üò† Outrage Response', category: 'Anger', body: '{{FIRSTNAME}}, did you see what they just did? [OUTRAGE]. We can\'t let this stand. Chip in {{AMOUNT}} to fight back: {{LINK}}' },
  { name: 'üéñÔ∏è Veterans/Military', category: 'Cause', body: '{{FIRSTNAME}}, our heroes gave everything for this country. Now they need us. Your {{AMOUNT}} helps [IMPACT]: {{LINK}}' },
  { name: 'üì¢ Survey/Poll CTA', category: 'Engagement', body: '{{FIRSTNAME}}, do you support [ISSUE]? Take our official survey and let your voice be heard: {{LINK}}' },
];

function renderTemplates() {
  document.getElementById('templateGrid').innerHTML = templates.map(t =>
    `<div class="template-card" onclick="loadTemplate('${t.body.replace(/'/g, "\\'")}')">
      <h4>${t.name}</h4>
      <span class="badge badge-sms" style="margin-bottom:6px;">${t.category}</span>
      <p>${t.body.substring(0, 80)}...</p>
    </div>`
  ).join('');
}

function loadTemplate(body) {
  document.getElementById('msgBody').value = body;
  document.querySelectorAll('.tab')[0].click();
  updateCompose();
}

// === COMPLIANCE ===
function runComplianceCheck() {
  const text = document.getElementById('complianceText').value;
  if (!text) { document.getElementById('complianceResults').innerHTML = ''; return; }

  const issues = [];
  const passes = [];

  // Length
  if (text.length <= 160) passes.push('‚úÖ Within SMS single-segment limit');
  else if (text.length <= 320) issues.push({ level: 'warn', text: `‚ö†Ô∏è ${Math.ceil(text.length/153)} SMS segments ‚Äî cost multiplier` });
  else issues.push({ level: 'error', text: `‚ùå ${Math.ceil(text.length/153)} SMS segments ‚Äî likely too long` });

  // Opt-out
  if (/stop|opt.?out|unsubscribe|reply stop/i.test(text)) passes.push('‚úÖ Opt-out language present');
  else issues.push({ level: 'error', text: '‚ùå No opt-out language (STOP/unsubscribe) ‚Äî required for initial contact' });

  // Sender ID
  if (/paid for by|from the|from [A-Z]/i.test(text)) passes.push('‚úÖ Sender identification detected');
  else issues.push({ level: 'warn', text: '‚ö†Ô∏è No clear sender identification' });

  // Prohibited words
  const prohibited = ['guaranteed', 'promise you', 'free money', 'act now or else'];
  prohibited.forEach(w => {
    if (text.toLowerCase().includes(w)) issues.push({ level: 'error', text: `‚ùå Prohibited phrase: "${w}"` });
  });

  // Match claims
  if (/\d+x match/i.test(text) && !/verified|authorized|sponsored/i.test(text))
    issues.push({ level: 'warn', text: '‚ö†Ô∏è Match claim without verification language' });

  // First person impersonation
  if (/^(I am|I\'m|This is) (President|Senator|Governor|Congressman)/i.test(text))
    issues.push({ level: 'error', text: '‚ùå Possible first-person candidate impersonation' });

  // ALL CAPS overuse
  const capsWords = (text.match(/\b[A-Z]{4,}\b/g) || []).length;
  if (capsWords > 5) issues.push({ level: 'warn', text: `‚ö†Ô∏è Heavy CAPS usage (${capsWords} words) ‚Äî may trigger spam filters` });

  // Merge field validation
  const badMerge = text.match(/\{[A-Z_]+\}(?!\})/g);
  if (badMerge) issues.push({ level: 'error', text: `‚ùå Malformed merge field(s): ${badMerge.join(', ')} ‚Äî use double braces` });

  let html = '';
  if (issues.length === 0) {
    html = '<div style="padding:12px; background:rgba(34,197,94,0.1); border-radius:8px; color:var(--green); font-weight:600;">‚úÖ All checks passed!</div>';
  } else {
    html = issues.map(i => `<div style="padding:8px 12px; margin-bottom:4px; border-radius:6px; background:${i.level === 'error' ? 'rgba(239,68,68,0.1)' : 'rgba(234,179,8,0.1)'}; font-size:14px;">${i.text}</div>`).join('');
  }
  html += passes.map(p => `<div style="padding:8px 12px; margin-bottom:4px; font-size:14px;">${p}</div>`).join('');

  document.getElementById('complianceResults').innerHTML = html;
}

// === YIELD CALCULATOR ===
function calcYield() {
  const listSize = parseInt(document.getElementById('listSize').value) || 0;
  const ctr = parseFloat(document.getElementById('ctr').value) || 0;
  const convRate = parseFloat(document.getElementById('convRate').value) || 0;
  const avgGift = parseFloat(document.getElementById('avgGift').value) || 0;
  const costPerMsg = parseFloat(document.getElementById('costPerMsg').value) || 0;
  const segments = parseInt(document.getElementById('segments').value) || 1;

  const clicks = Math.round(listSize * (ctr / 100));
  const conversions = Math.round(clicks * (convRate / 100));
  const revenue = conversions * avgGift;
  const cost = listSize * costPerMsg * segments;
  const profit = revenue - cost;
  const roi = cost > 0 ? ((profit / cost) * 100).toFixed(0) : 0;
  const yieldPerSend = listSize > 0 ? (revenue / listSize * 1000).toFixed(2) : 0;

  document.getElementById('yieldStats').innerHTML = `
    <div class="stat"><div class="val">${clicks.toLocaleString()}</div><div class="lbl">Clicks</div></div>
    <div class="stat"><div class="val">${conversions.toLocaleString()}</div><div class="lbl">Conversions</div></div>
    <div class="stat"><div class="val">$${revenue.toLocaleString()}</div><div class="lbl">Revenue</div></div>
    <div class="stat"><div class="val">$${cost.toLocaleString()}</div><div class="lbl">Send Cost</div></div>
    <div class="stat"><div class="val" style="color:${profit >= 0 ? 'var(--green)' : 'var(--red)'}">$${profit.toLocaleString()}</div><div class="lbl">Net Profit</div></div>
    <div class="stat"><div class="val" style="color:${profit >= 0 ? 'var(--green)' : 'var(--red)'}">${roi}%</div><div class="lbl">ROI</div></div>
    <div class="stat"><div class="val">$${yieldPerSend}</div><div class="lbl">Yield/1K Sends</div></div>
  `;

  // Scenario table
  const scenarios = [
    { name: 'Conservative', ctrMult: 0.7, convMult: 0.8 },
    { name: 'Baseline', ctrMult: 1, convMult: 1 },
    { name: 'Optimistic', ctrMult: 1.3, convMult: 1.2 },
    { name: 'Viral/Hot', ctrMult: 2, convMult: 1.5 },
  ];

  let table = '<table style="width:100%; border-collapse:collapse;">';
  table += '<tr style="border-bottom:1px solid var(--border);"><th style="text-align:left;padding:8px;">Scenario</th><th style="text-align:right;padding:8px;">CTR</th><th style="text-align:right;padding:8px;">Conv</th><th style="text-align:right;padding:8px;">Revenue</th><th style="text-align:right;padding:8px;">Profit</th><th style="text-align:right;padding:8px;">ROI</th></tr>';

  scenarios.forEach(s => {
    const sCtr = ctr * s.ctrMult;
    const sClicks = Math.round(listSize * (sCtr / 100));
    const sConv = Math.round(sClicks * (convRate * s.convMult / 100));
    const sRev = sConv * avgGift;
    const sProfit = sRev - cost;
    const sRoi = cost > 0 ? ((sProfit / cost) * 100).toFixed(0) : 0;
    const color = sProfit >= 0 ? 'var(--green)' : 'var(--red)';
    table += `<tr style="border-bottom:1px solid var(--border);">
      <td style="padding:8px;">${s.name}</td>
      <td style="text-align:right;padding:8px;">${sCtr.toFixed(1)}%</td>
      <td style="text-align:right;padding:8px;">${sConv.toLocaleString()}</td>
      <td style="text-align:right;padding:8px;">$${sRev.toLocaleString()}</td>
      <td style="text-align:right;padding:8px;color:${color}">$${sProfit.toLocaleString()}</td>
      <td style="text-align:right;padding:8px;color:${color}">${sRoi}%</td>
    </tr>`;
  });
  table += '</table>';
  document.getElementById('scenarioTable').innerHTML = table;
}

// === INIT ===
updateCompose();
updateAskStrings();
renderTemplates();
calcYield();
</script>
</body>
</html>
