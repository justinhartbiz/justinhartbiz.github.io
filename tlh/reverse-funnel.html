<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TLH ‚Äî Reverse Funnel Calculator</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    padding: 24px;
  }
  h1 {
    text-align: center;
    font-size: 1.6rem;
    color: #f8fafc;
    margin-bottom: 4px;
  }
  .subtitle {
    text-align: center;
    color: #64748b;
    font-size: 0.85rem;
    margin-bottom: 24px;
  }

  /* Funnels container */
  .funnels {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }
  @media (max-width: 900px) { .funnels { grid-template-columns: 1fr; max-width: 400px; } }

  .funnel-col {
    background: #1e293b;
    border-radius: 12px;
    border: 1px solid #334155;
    padding: 20px;
    position: relative;
  }

  .funnel-header {
    text-align: center;
    margin-bottom: 12px;
  }
  .funnel-city {
    font-size: 1.1rem;
    font-weight: 700;
    color: #f8fafc;
  }
  .funnel-city-tag {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-top: 4px;
  }
  .sd .funnel-city-tag { background: #1d4ed8; color: #dbeafe; }
  .oc .funnel-city-tag { background: #b45309; color: #fef3c7; }
  .la .funnel-city-tag { background: #7c3aed; color: #ede9fe; }

  /* Target wins input */
  .target-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 12px;
  }
  .target-label {
    font-size: 0.8rem;
    color: #94a3b8;
  }
  .target-input {
    width: 60px;
    padding: 6px 8px;
    background: #0f172a;
    border: 2px solid #22c55e;
    border-radius: 8px;
    color: #22c55e;
    font-size: 1.1rem;
    text-align: center;
    font-weight: 700;
  }
  .target-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(34,197,94,0.3); }

  /* Per-market rates */
  .market-rates {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
    margin-bottom: 14px;
    padding: 8px;
    background: #0f172a;
    border-radius: 8px;
    border: 1px solid #334155;
  }
  .market-rate {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
  }
  .market-rate label {
    font-size: 0.6rem;
    color: #64748b;
    text-align: center;
    line-height: 1.2;
    white-space: nowrap;
  }
  .market-rate-row {
    display: flex;
    align-items: center;
    gap: 2px;
  }
  .rate-input {
    width: 46px;
    padding: 4px 4px;
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 5px;
    color: #f1f5f9;
    font-size: 0.8rem;
    text-align: center;
    font-weight: 600;
  }
  .rate-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
  .rate-unit { color: #64748b; font-size: 0.7rem; }

  /* Funnel SVG + layers */
  .funnel-visual {
    position: relative;
    width: 100%;
    height: 340px;
  }

  /* Funnel layer overlays */
  .funnel-layer {
    position: absolute;
    left: 0;
    right: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .layer-number {
    font-size: 1.5rem;
    font-weight: 800;
    color: #f8fafc;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    line-height: 1.1;
  }
  .layer-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.9;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  .layer-rate {
    font-size: 0.65rem;
    opacity: 0.7;
    margin-top: 1px;
  }

  /* Colors per layer */
  .layer-wins .layer-number { color: #4ade80; }
  .layer-wins .layer-label { color: #86efac; }
  .layer-meetings .layer-number { color: #60a5fa; }
  .layer-meetings .layer-label { color: #93c5fd; }
  .layer-filtered .layer-number { color: #fbbf24; }
  .layer-filtered .layer-label { color: #fcd34d; }
  .layer-leads .layer-number { color: #f87171; }
  .layer-leads .layer-label { color: #fca5a5; }

  /* Totals bar */
  .totals-bar {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 12px;
    max-width: 1200px;
    margin: 24px auto 0;
  }
  .total-card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 10px;
    padding: 14px;
    text-align: center;
  }
  .total-label {
    font-size: 0.75rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .total-number {
    font-size: 1.6rem;
    font-weight: 800;
  }
  .total-wins .total-number { color: #4ade80; }
  .total-meetings .total-number { color: #60a5fa; }
  .total-filtered .total-number { color: #fbbf24; }
  .total-leads .total-number { color: #f87171; }

  .footer {
    text-align: center;
    margin-top: 20px;
    color: #475569;
    font-size: 0.7rem;
  }
</style>
</head>
<body>

<h1>üè† True Legacy Homes ‚Äî Reverse Funnel</h1>
<div class="subtitle">How many leads do we need to hit monthly win targets?</div>

<!-- Master Controls -->
<div style="display:flex; justify-content:center; gap:28px; margin-bottom:20px; padding:12px 24px; background:#1e293b; border-radius:10px; border:1px solid #334155; max-width:700px; margin-left:auto; margin-right:auto; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
  <span style="font-size:0.75rem; color:#94a3b8; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Master</span>
  <div style="display:flex; align-items:center; gap:6px;">
    <label style="font-size:0.75rem; color:#64748b;">Opp‚ÜíWin</label>
    <input type="number" class="rate-input" id="master-opp-win" value="35" min="1" max="100" step="1">
    <span class="rate-unit">%</span>
  </div>
  <div style="display:flex; align-items:center; gap:6px;">
    <label style="font-size:0.75rem; color:#64748b;">Lead‚ÜíOpp</label>
    <input type="number" class="rate-input" id="master-lead-opp" value="30" min="1" max="100" step="1">
    <span class="rate-unit">%</span>
  </div>
  <div style="display:flex; align-items:center; gap:6px;">
    <label style="font-size:0.75rem; color:#64748b;">Raw‚ÜíFiltered</label>
    <input type="number" class="rate-input" id="master-raw-filtered" value="40" min="1" max="100" step="1">
    <span class="rate-unit">%</span>
  </div>
</div>

<!-- Three Funnels -->
<div class="funnels">
  <!-- San Diego -->
  <div class="funnel-col sd" data-market="sd">
    <div class="funnel-header">
      <div class="funnel-city">San Diego</div>
      <div class="funnel-city-tag">PRIMARY MARKET</div>
    </div>
    <div class="target-row">
      <span class="target-label">Monthly Wins:</span>
      <input type="number" class="target-input" data-target="sd" value="10" min="1" max="999">
    </div>
    <div class="market-rates">
      <div class="market-rate">
        <label>Opp‚ÜíWin</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="opp-win" data-market="sd" value="35" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
      <div class="market-rate">
        <label>Lead‚ÜíOpp</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="lead-opp" data-market="sd" value="30" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
      <div class="market-rate">
        <label>Raw‚ÜíFiltered</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="raw-filtered" data-market="sd" value="40" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
    </div>
    <div class="funnel-visual" id="funnel-sd"></div>
  </div>

  <!-- Orange County -->
  <div class="funnel-col oc" data-market="oc">
    <div class="funnel-header">
      <div class="funnel-city">Orange County</div>
      <div class="funnel-city-tag">EXPANSION</div>
    </div>
    <div class="target-row">
      <span class="target-label">Monthly Wins:</span>
      <input type="number" class="target-input" data-target="oc" value="6" min="1" max="999">
    </div>
    <div class="market-rates">
      <div class="market-rate">
        <label>Opp‚ÜíWin</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="opp-win" data-market="oc" value="35" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
      <div class="market-rate">
        <label>Lead‚ÜíOpp</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="lead-opp" data-market="oc" value="30" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
      <div class="market-rate">
        <label>Raw‚ÜíFiltered</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="raw-filtered" data-market="oc" value="40" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
    </div>
    <div class="funnel-visual" id="funnel-oc"></div>
  </div>

  <!-- Los Angeles -->
  <div class="funnel-col la" data-market="la">
    <div class="funnel-header">
      <div class="funnel-city">Los Angeles</div>
      <div class="funnel-city-tag">EXPANSION</div>
    </div>
    <div class="target-row">
      <span class="target-label">Monthly Wins:</span>
      <input type="number" class="target-input" data-target="la" value="6" min="1" max="999">
    </div>
    <div class="market-rates">
      <div class="market-rate">
        <label>Opp‚ÜíWin</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="opp-win" data-market="la" value="35" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
      <div class="market-rate">
        <label>Lead‚ÜíOpp</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="lead-opp" data-market="la" value="30" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
      <div class="market-rate">
        <label>Raw‚ÜíFiltered</label>
        <div class="market-rate-row">
          <input type="number" class="rate-input" data-rate="raw-filtered" data-market="la" value="40" min="1" max="100" step="1">
          <span class="rate-unit">%</span>
        </div>
      </div>
    </div>
    <div class="funnel-visual" id="funnel-la"></div>
  </div>
</div>

<!-- Combined Totals -->
<div class="totals-bar">
  <div class="total-card total-wins">
    <div class="total-label">Total Wins / mo</div>
    <div class="total-number" id="total-wins">‚Äî</div>
  </div>
  <div class="total-card total-meetings">
    <div class="total-label">Total Meetings / mo</div>
    <div class="total-number" id="total-meetings">‚Äî</div>
  </div>
  <div class="total-card total-filtered">
    <div class="total-label">Total Filtered Leads / mo</div>
    <div class="total-number" id="total-filtered">‚Äî</div>
  </div>
  <div class="total-card total-leads">
    <div class="total-label">Total Raw Leads / mo</div>
    <div class="total-number" id="total-leads">‚Äî</div>
  </div>
</div>

<div class="footer">True Legacy Homes ¬∑ Executive Review ¬∑ Per-market rates editable ¬∑ Numbers recalculate instantly</div>

<script>
const colors = {
  wins:    { fill: 'rgba(34,197,94,0.35)',  stroke: '#22c55e' },
  meetings:{ fill: 'rgba(59,130,246,0.30)', stroke: '#3b82f6' },
  filtered:{ fill: 'rgba(251,191,36,0.25)', stroke: '#f59e0b' },
  leads:   { fill: 'rgba(248,113,113,0.25)',stroke: '#ef4444' }
};

function calcFunnel(wins, rateOppWin, rateLeadOpp, rateRawFiltered) {
  const meetings = Math.ceil(wins / (rateOppWin / 100));
  const filtered = Math.ceil(meetings / (rateLeadOpp / 100));
  const leads    = Math.ceil(filtered / (rateRawFiltered / 100));
  return { wins, meetings, filtered, leads };
}

function getMarketRates(market) {
  const ow = parseFloat(document.querySelector(`[data-rate="opp-win"][data-market="${market}"]`).value) || 35;
  const lo = parseFloat(document.querySelector(`[data-rate="lead-opp"][data-market="${market}"]`).value) || 30;
  const rf = parseFloat(document.querySelector(`[data-rate="raw-filtered"][data-market="${market}"]`).value) || 40;
  return { ow, lo, rf };
}

function drawFunnel(containerId, data, rates) {
  const container = document.getElementById(containerId);
  const W = container.offsetWidth;
  const H = 340;
  const pad = 12;
  const layerH = (H - pad * 2) / 4;
  const maxW = W - 24;
  const minW = maxW * 0.22;

  const maxVal = data.leads || 1;
  const getW = (val) => minW + (maxW - minW) * (val / maxVal);

  const layers = [
    { key: 'leads',    val: data.leads,    label: 'RAW LEADS',      cls: 'layer-leads' },
    { key: 'filtered', val: data.filtered, label: 'FILTERED LEADS', cls: 'layer-filtered' },
    { key: 'meetings', val: data.meetings, label: 'MEETINGS',       cls: 'layer-meetings' },
    { key: 'wins',     val: data.wins,     label: 'WINS',           cls: 'layer-wins' }
  ];

  let svg = `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;

  layers.forEach((layer, i) => {
    const y = pad + i * layerH;
    const nextLayer = layers[i + 1];
    const topW = getW(layer.val);
    const botW = nextLayer ? getW(nextLayer.val) : topW * 1.05;
    const cx = W / 2;

    const x1 = cx - topW / 2;
    const x2 = cx + topW / 2;
    const x3 = cx + botW / 2;
    const x4 = cx - botW / 2;

    const gap = 2;
    svg += `<polygon 
      points="${x1},${y + gap} ${x2},${y + gap} ${x3},${y + layerH - gap} ${x4},${y + layerH - gap}" 
      fill="${colors[layer.key].fill}" 
      stroke="${colors[layer.key].stroke}" 
      stroke-width="1.5"
    />`;
  });

  svg += `</svg>`;
  container.innerHTML = svg;

  layers.forEach((layer, i) => {
    const y = pad + i * layerH;
    const div = document.createElement('div');
    div.className = `funnel-layer ${layer.cls}`;
    div.style.top = y + 'px';
    div.style.height = layerH + 'px';

    const rateText = i === 0 ? '' :
      i === 1 ? `‚Üì ${rates.rf}% filter` :
      i === 2 ? `‚Üì ${rates.lo}% qual` :
      `‚Üì ${rates.ow}% conv`;

    div.innerHTML = `
      <div class="layer-number">${layer.val.toLocaleString()}</div>
      <div class="layer-label">${layer.label}</div>
      ${rateText ? `<div class="layer-rate">${rateText}</div>` : ''}
    `;
    container.appendChild(div);
  });
}

function updateAll() {
  const markets = ['sd', 'oc', 'la'];
  let totals = { wins: 0, meetings: 0, filtered: 0, leads: 0 };

  markets.forEach(m => {
    const wins = parseInt(document.querySelector(`[data-target="${m}"]`).value) || 1;
    const rates = getMarketRates(m);
    const data = calcFunnel(wins, rates.ow, rates.lo, rates.rf);
    drawFunnel(`funnel-${m}`, data, rates);
    totals.wins += data.wins;
    totals.meetings += data.meetings;
    totals.filtered += data.filtered;
    totals.leads += data.leads;
  });

  document.getElementById('total-wins').textContent = totals.wins.toLocaleString();
  document.getElementById('total-meetings').textContent = totals.meetings.toLocaleString();
  document.getElementById('total-filtered').textContent = totals.filtered.toLocaleString();
  document.getElementById('total-leads').textContent = totals.leads.toLocaleString();
}

// Master controls push to all markets
['opp-win', 'lead-opp', 'raw-filtered'].forEach(rate => {
  document.getElementById(`master-${rate}`).addEventListener('input', (e) => {
    const val = e.target.value;
    document.querySelectorAll(`[data-rate="${rate}"]`).forEach(input => {
      input.value = val;
    });
    updateAll();
  });
});

// Per-market inputs
document.querySelectorAll('.rate-input:not([id^="master"]), .target-input').forEach(el => {
  el.addEventListener('input', updateAll);
});

updateAll();
window.addEventListener('resize', updateAll);
</script>

</body>
</html>
