<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Creative Shootout ‚Äî Group Chat | DonorBureau</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;600;700&family=Open+Sans:wght@400;500;600&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --db-navy:#0E3358;
  --db-navy-light:#1a4a7a;
  --db-gold:#F2AA1F;
  --db-gold-light:#f5be50;
  --db-white:#FFFFFF;
  --db-light-gray:#EEEFF0;
  --accent-red:#ef4444;
  --accent-green:#10b981;
  --text:#333;
  --text-muted:#666;
}
body{background:var(--db-light-gray);font-family:'Open Sans',system-ui,sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;color:var(--text)}

/* Phone frame */
.phone{width:400px;max-width:95vw;height:90vh;max-height:820px;background:var(--db-white);border-radius:40px;border:3px solid var(--db-navy);display:flex;flex-direction:column;overflow:hidden;position:relative;box-shadow:0 8px 40px rgba(14,51,88,.2)}
.notch{width:160px;height:30px;background:var(--db-navy);border-radius:0 0 20px 20px;margin:0 auto;position:relative;z-index:10}

/* Top bar */
.top-bar{padding:4px 16px 10px;text-align:center;border-bottom:1px solid rgba(14,51,88,.1);background:var(--db-light-gray)}
.top-bar .title{font-family:'Lato',sans-serif;font-size:.95em;font-weight:700;color:var(--db-navy)}
.top-bar .subtitle{font-size:.7em;color:var(--text-muted);margin-top:2px}
.back-link{position:absolute;left:16px;top:38px;color:var(--db-gold);text-decoration:none;font-size:.85em}

/* Chat area */
.chat-area{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:2px;scroll-behavior:smooth;background:var(--db-white)}

/* Messages */
.msg-group{display:flex;flex-direction:column;gap:1px;margin-bottom:8px}
.sender-name{font-size:.7em;font-weight:600;margin-left:48px;margin-bottom:2px}
.sender-patriot{color:var(--db-navy)}
.sender-skeptic{color:var(--db-gold-light)}
.sender-urgency{color:var(--accent-red)}
.sender-consensus{color:var(--accent-green)}

.msg-row{display:flex;align-items:flex-end;gap:8px}
.msg-row.right{flex-direction:row-reverse}

.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9em;flex-shrink:0}
.avatar-patriot{background:rgba(14,51,88,.1)}
.avatar-skeptic{background:rgba(242,170,31,.15)}
.avatar-urgency{background:rgba(239,68,68,.1)}
.avatar-consensus{background:rgba(16,185,129,.1)}
.avatar-user{background:var(--db-gold)}

.bubble{max-width:75%;padding:9px 14px;font-size:.88em;line-height:1.4;border-radius:18px;word-wrap:break-word}
.bubble-patriot{background:var(--db-navy);color:var(--db-white);border-bottom-left-radius:4px}
.bubble-skeptic{background:var(--db-gold);color:var(--db-navy);border-bottom-left-radius:4px}
.bubble-urgency{background:var(--accent-red);color:var(--db-white);border-bottom-left-radius:4px}
.bubble-user{background:var(--db-navy-light);color:var(--db-white);border-bottom-right-radius:4px}

/* Consensus special bubble */
.consensus-bubble{background:var(--db-light-gray);border:2px solid var(--accent-green);border-radius:16px;padding:14px;margin:12px 8px;text-align:center}
.consensus-bubble .label{color:var(--accent-green);font-family:'Lato',sans-serif;font-weight:700;font-size:.75em;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.consensus-bubble .body{font-size:.85em;line-height:1.5;color:var(--text);text-align:left;white-space:pre-line}

/* Typing indicator */
.typing-indicator{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding-left:48px}
.typing-indicator .name{font-size:.7em;font-weight:600;color:var(--text-muted)}
.typing-dots{display:flex;gap:4px}
.typing-dots span{width:7px;height:7px;background:var(--text-muted);border-radius:50%;animation:typingBounce 1.4s infinite}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-4px);opacity:1}}

/* Input bar */
.input-bar{padding:8px 10px;border-top:1px solid rgba(14,51,88,.1);display:flex;gap:8px;align-items:flex-end;background:var(--db-light-gray)}
.input-bar textarea{flex:1;background:var(--db-white);border:1px solid rgba(14,51,88,.15);border-radius:20px;color:var(--text);padding:10px 16px;font-family:inherit;font-size:.88em;resize:none;height:40px;max-height:80px;outline:none}
.input-bar textarea::placeholder{color:var(--text-muted)}
.input-bar textarea:focus{border-color:var(--db-gold)}
.send-btn{width:36px;height:36px;border-radius:50%;background:var(--db-gold);border:none;color:var(--db-navy);font-size:1.1em;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .15s}
.send-btn:hover{transform:scale(1.1);background:var(--db-gold-light)}
.send-btn:disabled{background:var(--db-light-gray);color:var(--text-muted);cursor:default;transform:none}

/* Fade in */
.fade-in{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Speed toggle */
.speed-toggle{position:fixed;top:12px;right:16px;background:var(--db-white);border:1px solid rgba(14,51,88,.15);border-radius:20px;padding:6px 14px;font-size:.8em;cursor:pointer;z-index:100;color:var(--text);user-select:none;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.speed-toggle:hover{border-color:var(--db-gold)}
.speed-toggle.fast{border-color:var(--db-gold);color:var(--db-gold);background:rgba(242,170,31,.05)}

/* Home indicator */
.home-bar{height:20px;display:flex;align-items:center;justify-content:center;background:var(--db-light-gray)}
.home-bar div{width:120px;height:4px;background:var(--db-navy);border-radius:2px;opacity:.3}

/* DB branding */
.db-badge{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:6px;background:var(--db-white);padding:6px 14px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);font-size:.75em}
.db-badge-icon{width:20px;height:20px;background:var(--db-gold);border-radius:4px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:var(--db-navy);font-size:.6rem}
.db-badge-text{color:var(--db-navy);font-weight:600}
</style>
<script src="live-mode.js"></script>
</head>
<body>

<div class="speed-toggle" id="speedToggle" onclick="toggleSpeed()">üê¢ Presentation</div>

<div class="phone">
  <div class="notch"></div>
  <div class="top-bar">
    <div class="title">üéØ AI Creative Shootout</div>
    <div class="subtitle">ü¶Ö Patriot ¬∑ üîç Skeptic ¬∑ üî• Urgency</div>
  </div>

  <div class="chat-area" id="chatArea"></div>

  <div class="input-bar">
    <textarea id="userInput" placeholder="Paste your draft copy...">"The radical left is destroying America! Send $5 now!"</textarea>
    <button class="send-btn" id="sendBtn" onclick="startChat()">‚Üë</button>
  </div>
  <div class="home-bar"><div></div></div>
</div>

<div class="db-badge">
  <div class="db-badge-icon">DB</div>
  <div class="db-badge-text">DONORBUREAU</div>
</div>

<script>
const chat = document.getElementById('chatArea');
const sendBtn = document.getElementById('sendBtn');
const userInput = document.getElementById('userInput');
let running = false;
let slowMode = true;

function toggleSpeed() {
  slowMode = !slowMode;
  const btn = document.getElementById('speedToggle');
  btn.textContent = slowMode ? 'üê¢ Presentation' : 'üêá Fast';
  btn.classList.toggle('fast', !slowMode);
}

const SCRIPT = [
  {
    who: 'patriot',
    name: 'ü¶Ö The Patriot',
    text: 'Hold on. "Destroying America"? That\'s fear, not inspiration. Where\'s the PROMISE of greatness? I want a shining city on a hill, not a dumpster fire. This makes me want to hide, not donate.'
  },
  {
    who: 'skeptic',
    name: 'üîç The Skeptic',
    text: '"The radical left is destroying America" ‚Äî which part, specifically? The economy? Schools? This is vague fear-mongering. And "Send $5 now" ‚Äî why $5? Why not explain what the $5 DOES?'
  },
  {
    who: 'urgency',
    name: 'üî• The Urgency',
    text: 'WEAK. SO WEAK!! Where\'s the DEADLINE?! Where\'s the MATCH?! "Send $5 now" ‚Äî NOW isn\'t urgent enough! I need a COUNTDOWN TIMER, a 3X MATCH, and an EXPIRATION or NOBODY CLICKS ANYTHING!'
  },
  {
    who: 'patriot',
    name: 'ü¶Ö The Patriot',
    text: 'Look, I get it ‚Äî you want emotion. But POSITIVE emotion converts better. "Protect the American Dream" hits harder than "they\'re destroying everything." Give people something to fight FOR.'
  },
  {
    who: 'skeptic',
    name: 'üîç The Skeptic',
    text: 'I agree with Patriot on this one. I ran the numbers on 400 fundraising emails ‚Äî specific claims outperform vague ones by 3.2x. Also, social proof: "Join 47,000 patriots" crushes "Send $5."'
  },
  {
    who: 'urgency',
    name: 'üî• The Urgency',
    text: 'OK FINE, Skeptic has a point with the data. But here\'s what I NEED: (1) A deadline ‚Äî "midnight tonight." (2) A match ‚Äî "3X MATCH." (3) A consequence ‚Äî "or this expires FOREVER." THAT\'S the formula!'
  },
  {
    who: 'patriot',
    name: 'ü¶Ö The Patriot',
    text: 'What about this: "America\'s greatest chapter hasn\'t been written yet ‚Äî and YOU hold the pen." That\'s aspirational. That\'s Kennedy energy. People donate to HOPE, not despair.'
  },
  {
    who: 'skeptic',
    name: 'üîç The Skeptic',
    text: 'I actually... don\'t hate that, Patriot. But ground it. "We\'re $12,000 away from flipping District 7" ‚Äî THAT I can believe. Abstract hope + concrete target = magic formula.'
  },
  {
    who: 'urgency',
    name: 'üî• The Urgency',
    text: 'FINE. Keep your poetry! But ADD: "Your $5 becomes $15 with tonight\'s 3X match ‚Äî expires at MIDNIGHT." Hope + specifics + deadline. NOW WE\'RE COOKING! üî•'
  },
  {
    who: 'patriot',
    name: 'ü¶Ö The Patriot',
    text: 'I love it but "expires" sounds like a coupon. We\'re not selling yogurt. How about: "This moment won\'t wait." More gravitas.'
  },
  {
    who: 'skeptic',
    name: 'üîç The Skeptic',
    text: 'Patriot, "this moment won\'t wait" is vague again. BUT ‚Äî has anyone considered a P.S. line? P.S. lines get 79% more reads than body copy. Put the match offer there. Urgency, you\'ll love this.'
  },
  {
    who: 'urgency',
    name: 'üî• The Urgency',
    text: 'SKEPTIC IS RIGHT AND I HATE ADMITTING IT!! The P.S. is PRIME REAL ESTATE! "P.S. Your 3X match expires at midnight. Don\'t leave $10 on the table." SHIP IT!!'
  },
  {
    who: 'patriot',
    name: 'ü¶Ö The Patriot',
    text: '‚úÖ That\'s the one. Dignity, specifics, and urgency ‚Äî all in harmony. I\'m proud of us.'
  },
  {
    who: 'skeptic',
    name: 'üîç The Skeptic',
    text: '‚úÖ Surprisingly... I approve. Every claim is grounded. The ask is clear. Well done, team.'
  },
  {
    who: 'urgency',
    name: 'üî• The Urgency',
    text: '‚úÖ FINALLY! SHIP IT! SHIP IT NOW BEFORE MIDNIGHT!! üöÄüî•'
  }
];

const FINAL_COPY = `Subject: The chapter that changes everything

Friend,

America's greatest chapter hasn't been written yet ‚Äî and YOU hold the pen.

Right now, we're just $12,000 away from our goal to flip District 7. And thanks to a group of dedicated patriots, every dollar you give tonight is TRIPLED.

Your $5 becomes $15. But only until midnight.

Join 47,000 Americans who are writing the next chapter ‚Äî not with fear, but with action.

‚Üí Rush your 3X-matched gift now

P.S. Your 3X match expires at midnight tonight. Don't leave $10 on the table ‚Äî give your $5 now and make it count three times over.`;

function addUserBubble(text) {
  const group = document.createElement('div');
  group.className = 'msg-group fade-in';
  group.innerHTML = `
    <div class="msg-row right">
      <div class="bubble bubble-user">${esc(text)}</div>
    </div>`;
  chat.appendChild(group);
  scrollDown();
}

function showTyping(who, name) {
  const el = document.createElement('div');
  el.className = 'typing-indicator fade-in';
  el.id = 'typing';
  el.innerHTML = `<span class="name">${name} is typing</span><div class="typing-dots"><span></span><span></span><span></span></div>`;
  chat.appendChild(el);
  scrollDown();
  return el;
}

function addBubble(who, name, text, showName) {
  const group = document.createElement('div');
  group.className = 'msg-group fade-in';
  group.innerHTML = `
    ${showName ? `<div class="sender-name sender-${who}">${name}</div>` : ''}
    <div class="msg-row">
      <div class="avatar avatar-${who}">${name.split(' ')[0]}</div>
      <div class="bubble bubble-${who}">${esc(text)}</div>
    </div>`;
  chat.appendChild(group);
  scrollDown();
}

function addConsensus(text) {
  const el = document.createElement('div');
  el.className = 'consensus-bubble fade-in';
  el.innerHTML = `<div class="label">üìã Shared Note ‚Äî Final Copy</div><div class="body">${esc(text)}</div>`;
  chat.appendChild(el);
  scrollDown();
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function scrollDown() { chat.scrollTop = chat.scrollHeight; }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function addStreamBubble(who, name, showName) {
  const group = document.createElement('div');
  group.className = 'msg-group fade-in';
  group.innerHTML = `
    ${showName ? `<div class="sender-name sender-${who}">${name}</div>` : ''}
    <div class="msg-row">
      <div class="avatar avatar-${who}">${name.split(' ')[0]}</div>
      <div class="bubble bubble-${who}"><span class="stream-text"></span><span class="typing-dots" style="display:inline-flex;vertical-align:middle;margin-left:4px"><span></span><span></span><span></span></span></div>
    </div>`;
  chat.appendChild(group);
  scrollDown();
  const span = group.querySelector('.stream-text');
  const dots = group.querySelector('.typing-dots');
  return {
    append(text) { span.textContent += text; scrollDown(); },
    finish() { dots.remove(); },
    getText() { return span.textContent; }
  };
}

const CHAR_NAMES = { patriot: 'ü¶Ö The Patriot', skeptic: 'üîç The Skeptic', urgency: 'üî• The Urgency' };
const CHAR_ORDER = ['patriot', 'skeptic', 'urgency'];

async function startChatLive() {
  const draft = userInput.value.trim();
  if (!draft) return;
  running = true;
  sendBtn.disabled = true;
  addUserBubble(draft);
  userInput.value = '';
  await sleep(400);

  const history = { patriot: [], skeptic: [], urgency: [] };
  const allTexts = [];

  try {
    const rounds = LiveMode.ROUND_PROMPTS;
    for (let r = 0; r < rounds.length; r++) {
      const historyStr = allTexts.map(t => `${t.who}: ${t.text}`).join('\n');
      const userPrompt = rounds[r](draft, historyStr);
      let lastWho = allTexts.length ? allTexts[allTexts.length - 1].who : '';

      for (const char of CHAR_ORDER) {
        const typingEl = showTyping(char, CHAR_NAMES[char]);
        await sleep(300);
        typingEl.remove();
        const handle = addStreamBubble(char, CHAR_NAMES[char], char !== lastWho);
        for await (const chunk of LiveMode.streamCharacter(char, LiveMode.SYSTEM_PROMPTS[char], userPrompt, history[char])) {
          handle.append(chunk);
        }
        handle.finish();
        const text = handle.getText();
        history[char].push({ role: 'user', content: userPrompt });
        history[char].push({ role: 'assistant', content: text });
        allTexts.push({ who: char, text });
        lastWho = char;
        await sleep(200);
      }
    }

    await sleep(400);
    const historyStr = allTexts.map(t => `${t.who}: ${t.text}`).join('\n');
    const consensusPrompt = LiveMode.CONSENSUS_PROMPT(draft, historyStr);
    let finalText = '';
    for await (const chunk of LiveMode.streamCharacter('patriot', 'You are a master fundraising copywriter.', consensusPrompt, [])) {
      finalText += chunk;
    }
    addConsensus(finalText);
  } catch (e) {
    LiveMode.toast('‚ö†Ô∏è Live failed, falling back to simulation');
    console.error('Live error:', e);
    chat.innerHTML = '';
    running = false;
    sendBtn.disabled = false;
    userInput.value = draft;
    await startChatSimulated();
  }
}

async function startChatSimulated() {
  if (running) return;
  running = true;
  sendBtn.disabled = true;
  const draft = userInput.value.trim();
  if (!draft) return;

  addUserBubble(draft);
  userInput.value = '';
  await sleep(600);

  let lastWho = '';
  for (const line of SCRIPT) {
    const typingEl = showTyping(line.who, line.name);
    const delay = slowMode ? (2000 + Math.random() * 1500) : (800 + Math.random() * 1200);
    await sleep(delay);
    typingEl.remove();
    addBubble(line.who, line.name, line.text, line.who !== lastWho);
    lastWho = line.who;
    await sleep(slowMode ? 1200 : 300);
  }

  await sleep(800);
  addConsensus(FINAL_COPY);
}

async function startChat() {
  if (running) return;
  if (LiveMode.enabled) {
    await startChatLive();
  } else {
    await startChatSimulated();
  }
}
</script>
</body>
</html>
